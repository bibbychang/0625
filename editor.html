<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>編輯地圖</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; }
    #map { display: grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); gap: 2px; }
    .cell { width: 60px; height: 60px; border: 1px solid #aaa; position: relative; overflow: hidden; background: white; }
    .cell img { width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; }
    .order-number { position: absolute; bottom: 2px; right: 4px; font-size: 10px; background: rgba(255,255,255,0.7); padding: 1px 3px; border-radius: 4px; }
    #sidebar img { width: 60px; height: 60px; cursor: grab; border: 1px solid #aaa; border-radius: 6px; margin: 3px; background: white; }
  </style>
</head>
<body>
  <h2>🧩 編輯地圖與設定</h2>
  <label><input type="radio" name="mode" value="time" checked onchange="updateMode()"> 限時制</label>
  <select id="timeLimit">
    <option value="20">20 秒</option>
    <option value="50">50 秒</option>
    <option value="120">2 分鐘</option>
  </select>
  <label style="margin-left: 10px"><input type="radio" name="mode" value="score" onchange="updateMode()"> 積分制</label>
  <select id="scoreTarget" disabled>
    <option value="25">25 分</option>
    <option value="35">35 分</option>
    <option value="45">45 分</option>
  </select>

  <div id="sidebar"></div>
  <div id="map"></div>
  <button onclick="saveAndStart()">▶ 開始遊戲</button>

<script>
const images = ["start.png","goal.png","quiz.png","event1.png","event2.png","underdesk.png"];
const sidebar = document.getElementById("sidebar");
images.forEach(src => {
  const img = new Image();
  img.src = src;
  img.className = "item";
  img.draggable = true;
  img.dataset.img = src;
  sidebar.appendChild(img);
});

const mapEl = document.getElementById("map");
let placedOrder = [];
for (let i = 0; i < 64; i++) {
  const cell = document.createElement("div");
  cell.className = "cell";
  cell.dataset.cell = i;
  cell.ondragover = e => e.preventDefault();
  cell.ondrop = drop;
  mapEl.appendChild(cell);
}
function drop(e) {
  e.preventDefault();
  const filename = e.dataTransfer.getData('text/plain');
  const cell = e.target.closest('.cell');
  const index = parseInt(cell.dataset.cell);
  cell.innerHTML = '';
  const img = new Image();
  img.src = filename;
  cell.appendChild(img);
  if (!placedOrder.includes(index)) placedOrder.push(index);
}
function updateMode() {
  const timeSel = document.getElementById("timeLimit");
  const scoreSel = document.getElementById("scoreTarget");
  const mode = document.querySelector('input[name="mode"]:checked').value;
  timeSel.disabled = mode !== "time";
  scoreSel.disabled = mode !== "score";
}
function saveAndStart() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const timeLimit = parseInt(document.getElementById("timeLimit").value);
  const scoreTarget = parseInt(document.getElementById("scoreTarget").value);
  const cells = mapEl.querySelectorAll(".cell");
  const mapData = [];
  cells.forEach(cell => {
    const img = cell.querySelector("img");
    mapData.push(img ? img.src : null);
  });
  const config = {
    mode,
    timeLimit,
    scoreTarget,
    mapData,
    pathIndices: placedOrder
  };
  localStorage.setItem("gameConfig", JSON.stringify(config));
  window.location.href = "game.html";
}
</script>
</body>
</html>
