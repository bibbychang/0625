<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>迷宮大富翁</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #game-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      margin-top: 20px;
    }
    #left-ui, #right-ui {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 150px;
      min-height: 250px;
      background-color: #f9f9f9;
      border: 1px solid #aaa;
      padding: 10px;
      border-radius: 10px;
    }
    #left-ui::before {
      content: "👤 玩家 1";
      font-weight: bold;
      margin-bottom: 5px;
    }
    #right-ui::before {
      content: "玩家 2 👤";
      font-weight: bold;
      margin-bottom: 5px;
    }
    #left-ui:not(.active) *:not(:first-child),
    #right-ui:not(.active) *:not(:first-child) {
      display: none;
    }
    #left-ui.active, #right-ui.active {
      box-shadow: 0 0 10px 3px #ffd700;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 60px);
      grid-template-rows: repeat(8, 60px);
      gap: 2px;
      position: relative;
    }
    .cell {
      width: 60px;
      height: 60px;
      background-color: #f0f0f0;
      position: relative;
      font-size: 10px;
      text-align: right;
      padding: 2px;
    }
    .path img {
      width: 100%;
      height: 100%;
    }
    .player {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      position: absolute;
      top: 18px;
      left: 18px;
      z-index: 2;
    }
    .player1 { background-color: red; }
    .player2 { background-color: blue; }
    .ladder-line {
      position: absolute;
      width: 2px;
      background-color: green;
      z-index: 1;
    }
  </style>
</head>
<body>
  <h1>迷宮大富翁遊戲</h1>
  <div id="scoreboard">玩家 1 分數：<span id="score1">0</span> ｜ 玩家 2 分數：<span id="score2">0</span></div>
  <div id="game-container">
    <div id="left-ui">
      <button id="rollBtn1" onclick="rollDice(0)">🎲 玩家 1 擲骰</button>
      <p id="turnInfo1"></p>
      <p id="question1"></p>
      <input type="text" id="answer1" placeholder="輸入答案" />
      <button id="submitBtn1" onclick="checkAnswer(0)">送出答案</button>
    </div>
    <div id="board"></div>
    <div id="right-ui">
      <button id="rollBtn2" onclick="rollDice(1)">🎲 玩家 2 擲骰</button>
      <p id="turnInfo2"></p>
      <p id="question2"></p>
      <input type="text" id="answer2" placeholder="輸入答案" />
      <button id="submitBtn2" onclick="checkAnswer(1)">送出答案</button>
    </div>
  </div>
  <audio id="correctSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
  <audio id="diceSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>
  <script>
    const board = document.getElementById("board");
    const gridSize = 8;
    const maxSteps = 20;
    const path = [];
    const visited = Array.from({ length: gridSize }, () => Array(gridSize).fill(false));
    let currentPlayer = 0;
    let playerPositions = [0, 0];
    let scores = [0, 0];
    let diceRoll = 0;
    let currentQuestion = {};
    let ladder = null;
const imagePool = [
      "warning2.png", "ok1.png", "underdesk.png", "rain2.png", "ok3.png",
      "quiz.png", "fire2.png", "safezone.png", "rain3.png", "bus.png",
      "fire1.png", "event2.png", "rain1.png", "dice.png", "bag2.png",
      "earthquake1.png", "ok2.png", "warning1.png", "firstaid2.png", "event1.png",
      "earthquake3.png", "light.png"
    ];
    function updateUI() {
  const leftUI = document.getElementById("left-ui");
  const rightUI = document.getElementById("right-ui");

  if (currentPlayer === 0) {
    leftUI.style.visibility = "visible";
    rightUI.style.visibility = "hidden";
    leftUI.classList.add("active");
    rightUI.classList.remove("active");
  } else {
    leftUI.style.visibility = "hidden";
    rightUI.style.visibility = "visible";
    leftUI.classList.remove("active");
    rightUI.classList.add("active");
  }
}



    function isValid(x, y) {
      return x >= 0 && y >= 0 && x < gridSize && y < gridSize && !visited[y][x];
    }


 function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
	function countTurns(p) {
      let turns = 0;
      for (let i = 2; i < p.length; i++) {
        const [x0, y0] = p[i - 2];
        const [x1, y1] = p[i - 1];
        const [x2, y2] = p[i];
        const dx1 = x1 - x0, dy1 = y1 - y0;
        const dx2 = x2 - x1, dy2 = y2 - y1;
        if (dx1 !== dx2 || dy1 !== dy2) turns++;
      }
      return turns;
    }
    function dfs(x, y, steps, pathSoFar) {
      if (steps === 0) {
        path.push(...pathSoFar);
        return true;
      }
      const dirs = [[1,0], [-1,0], [0,1], [0,-1]];
      for (const [dx, dy] of dirs.sort(() => Math.random() - 0.5)) {
        const nx = x + dx, ny = y + dy;
        if (isValid(nx, ny)) {
          visited[ny][nx] = true;
          pathSoFar.push([nx, ny]);
          if (dfs(nx, ny, steps - 1, pathSoFar)) return true;
          pathSoFar.pop();
          visited[ny][nx] = false;
        }
      }
      return false;
    }

    function buildBoard() {
      board.innerHTML = "";
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.x = x;
          cell.dataset.y = y;
          board.appendChild(cell);
        }
      }
    }

    function renderPath() {
      shuffle(imagePool);
      const usedImages = ["start_yellow.png", ...imagePool.slice(0, path.length - 2), "goal.png"];
      path.forEach(([x, y], index) => {
        const cell = cells[y * gridSize + x];
        cell.classList.add("path");
        const img = document.createElement("img");
        img.src = `${usedImages[index]}`;
        cell.appendChild(img);

        const label = document.createElement("div");
        label.textContent = index;
        label.style.position = "absolute";
        label.style.bottom = "2px";
        label.style.right = "2px";
        label.style.fontSize = "8px";
        label.style.color = "black";
        label.style.backgroundColor = "rgba(255,255,255,0.7)";
        cell.appendChild(label);
      });
    }

    function placePlayers() {
      document.querySelectorAll(".player").forEach(e => e.remove());
      playerPositions.forEach((pos, i) => {
        const [x, y] = path[pos];
        const idx = y * gridSize + x;
        const cell = board.children[idx];
        const token = document.createElement("div");
        token.className = `player player${i+1}`;
        cell.appendChild(token);
      });
    }

    function generateLadder() {
      const candidates = path.slice(1, path.length - 1);
      for (let i = 0; i < candidates.length - 1; i++) {
        const a = candidates[i];
        const b = candidates[i + 1];
        const ai = path.findIndex(p => p[0] === a[0] && p[1] === a[1]);
        const bi = path.findIndex(p => p[0] === b[0] && p[1] === b[1]);
        if (Math.abs(ai - bi) > 2) {
          ladder = { from: a, to: b };
          drawLadderLine(a, b);
          break;
        }
      }
    }

    function drawLadderLine(from, to) {
      const cellSize = 62;
      const x1 = from[0] * cellSize + cellSize / 2;
      const y1 = from[1] * cellSize + cellSize / 2;
      const x2 = to[0] * cellSize + cellSize / 2;
      const y2 = to[1] * cellSize + cellSize / 2;
      const len = Math.sqrt((x2 - x1)**2 + (y2 - y1)**2);
      const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
      const line = document.createElement("div");
      line.className = "ladder-line";
      line.style.height = `${len}px`;
      line.style.left = `${x1}px`;
      line.style.top = `${y1}px`;
      line.style.transform = `translate(-1px, -1px) rotate(${angle}deg)`;
      board.appendChild(line);
    }

    function checkLadder(pos) {
      const [x, y] = path[pos];
      if (!ladder) return pos;
      if (x === ladder.from[0] && y === ladder.from[1]) {
        alert("你滑走了");
        return path.findIndex(p => p[0] === ladder.to[0] && p[1] === ladder.to[1]);
      }
      if (x === ladder.to[0] && y === ladder.to[1]) {
        alert("你滑走了");
        return path.findIndex(p => p[0] === ladder.from[0] && p[1] === ladder.from[1]);
      }
      return pos;
    }

    function rollDice(playerIdx) {
      if (playerIdx !== currentPlayer) return;
      diceRoll = Math.floor(Math.random() * 6) + 1;
      const a = Math.floor(Math.random() * 10);
      const b = Math.floor(Math.random() * 10);
      currentQuestion = { a, b };
      document.getElementById("question1").textContent = playerIdx === 0 ? `${a} + ${b} = ?` : "";
      document.getElementById("question2").textContent = playerIdx === 1 ? `${a} + ${b} = ?` : "";
      document.getElementById("turnInfo1").textContent = playerIdx === 0 ? `擲出 ${diceRoll} 點` : "";
      document.getElementById("turnInfo2").textContent = playerIdx === 1 ? `擲出 ${diceRoll} 點` : "";
    }

    function checkAnswer(playerIdx) {
      const val = parseInt(document.getElementById(playerIdx === 0 ? "answer1" : "answer2").value);
      if (val === currentQuestion.a + currentQuestion.b) {
        movePlayer();
      } else {
        alert("答錯了，換下一位");
        currentPlayer = 1 - currentPlayer;
        updateUI();
      }
    }

    function movePlayer() {
      playerPositions[currentPlayer] += diceRoll;
      if (playerPositions[currentPlayer] >= path.length) playerPositions[currentPlayer] = path.length - 1;
      playerPositions[currentPlayer] = checkLadder(playerPositions[currentPlayer]);
      placePlayers();
      if (playerPositions[currentPlayer] === path.length - 1) {
        alert(`玩家 ${currentPlayer+1} 抵達終點！`);
      } else {
        currentPlayer = 1 - currentPlayer;
        updateUI();
      }
    }

    visited[0][0] = true;
    dfs(0, 0, maxSteps, [[0, 0]]);
    buildBoard();
    renderPath();
    placePlayers();
    generateLadder();
    updateUI();
  </script>
</body>
</html>
